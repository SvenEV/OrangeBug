<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <style type="text/css">
            #app {
                display: grid;
                grid-template-rows: auto 1fr;
                overflow: hidden;
                position: absolute;
                width: 100%;
                height: 100%;
            }
            header {
                display: grid;
                grid-auto-flow: column;
                grid-auto-columns: min-content;
                align-items: center;
                grid-gap: 12px;
                background-color: #3C3C3C;
                color: black;
                font-weight: bold;
                font-size: larger;
            }
            header > h1 {
                background-color: #FFD800;
                margin: 0;
                padding: 8px 12px;
                font-size: 20px;
                font-family: 'Courier New', Courier, monospace;
            }
            main {
                overflow: auto;
            }
            button {
                border: none;
                outline: none;
                background-color: black;
                color: white;
                padding: 8px 12px;
                margin: 0;
            }
            button:hover {
                background-color: #404040;
                box-shadow: 0 0 20px black;
                transition: all .2s;
            }
            button:active {
                background-color: #404040;
                box-shadow: 0 0 8px black;
                transform: scale(.95);
                transition: all .2s;
            }
            body {
                margin: 0;
                padding: 0;
                background-color: #1E1E1E;
                color: white;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                overflow: hidden;
            }
            #logs > div:nth-child(odd) {
                background-color: #252526
            }
            p {
                margin: 0
            }
            .tree-node-expander {
                font-weight: bold;
                display: inline-block;
                width: 10px;
                cursor: pointer;
                color: #FFD800;
            }
            .tree-node-label {
                cursor: pointer;
                font-family: 'Courier New', Courier, monospace
            }
            .tree-node-children {
                margin-left: 4px;
                padding-left: 8px;
                border-left: 1px dotted gray;
            }
        </style>
    </head>
    <body>
        <div id="app">
            <header>
                <h1 id="title">lox</h1>
                <button v-for="cmd in commands" v-on:click="connection.invoke('InvokeCommand', cmd.label)">{{cmd.label}}</button>
            </header>
            <main>
                <div id="logs">
                    <log-message v-for="item in logs" v-bind="item"></log-message>
                </div>
                
            </main>
        </div>

        <script src="vue.js"></script>
        <script src="signalr.min.js"></script>
        <script type="text/javascript">
            Vue.component('log-message', {
                props: [ 'time', 'category', 'elements' ],
                template: `
                    <div class="log-message" style="padding: 4px 12px; display: grid; grid-template-columns: 142px 1fr min-content; grid-gap: 8px;">
                        <code style="font-size: small; color: gray; overflow: hidden; margin-top: 4px;">
                            <strong>{{time}}</strong>
                        </code>
                        <div style="display: grid; grid-auto-flow: row; grid-gap: 4px;">
                            <log-element v-for="elem in elements" :element="elem"></log-element>
                        </div>
                        <code>#{{category}}</code>
                    </div>
                `
            });

            Vue.component('tree-node', {
                props: {
                    text: { type: String },
                    object: { },
                    isExpanded: { type: Boolean }
                },
                data: c => { return { expand: c.isExpanded } },
                computed: {
                    isPrimitive: function () {
                        var t = typeof this.object;
                        return t !== "object" || Object.keys(this.object).length === 0
                    }
                },
                template: `
                    <div class="tree-node">
                        <span class="tree-node-expander" :style="{ visibility: isPrimitive ? 'visible' : 'visible' }" v-on:click="expand = !expand">
                            {{isPrimitive ? '&nbsp;Â·' : (expand ? 'v' : '>')}}
                        </span>
                        <span class="tree-node-label" v-on:click="expand = !expand">
                            {{isPrimitive ? (text + ": " + object) : text}}
                        </span>
                        <div class="tree-node-children" v-if="!isPrimitive && expand">
                            <tree-node v-for="(value, key) in object" :text="key.toString()" :object="value">
                            </tree-node>
                        </div>
                    </div>
                `
            })

            Vue.component('log-element', {
                props: [ 'element' ],
                template: `
                    <div class="log-element">
                        <span v-if="element.$type === 'LogMessage'">{{element.text}}</span>
                        <span v-if="element.$type === 'LogMarkdown'" v-html="element.text"></span>
                        <div v-if="element.$type === 'LogCommandBar'" style="display: grid; grid-auto-flow: column; grid-gap: 8px; grid-auto-columns: min-content;">
                            <button v-for="cmd in element.commands">{{cmd.label}}</button>
                        </div>
                        <tree-node v-if="element.$type === 'LogObject'"
                            :isExpanded="true"
                            :text="element.label"    
                            :object="element.o">
                        </tree-node>
                    </div>
                `
            })

            var app = new Vue({
                el: "#app",
                data: {
                    connection: null,
                    logs: [],
                    commands: []
                },
                created: function () {
                    this.connection = new signalR.HubConnectionBuilder()
                        .withUrl("/lox")
                        .build();
                    
                    this.connection.on("ReceiveLog", data => {
                        Object.freeze(data);
                        var main = document.getElementsByTagName("main")[0];
                        var isAtBottom = Math.abs(main.scrollHeight - main.scrollTop - main.clientHeight) < 100
                        app.logs.push(data);
                        if (isAtBottom) {
                            var logElements = document.getElementsByClassName("log-message");
                            logElements[logElements.length - 1].scrollIntoView();
                        }
                    });
        
                    this.connection.on("ReceiveCommands", data => {
                        app.commands = data;
                    })
                    
                    this.connection.start()
                        .then(() => {
                            app.logs = []
                            app.commands = []
                        })
                        .catch(() => {
                            app.logs = [
                                {
                                    time: "2018-08-23 23:43:00",
                                    category: "General",
                                    elements: [
                                        {
                                            $type: "LogMarkdown",
                                            text: "Hello World!"
                                        },
                                        {
                                            $type: "LogCommandBar",
                                            commands: [
                                                { label: "Pause" },
                                                { label: "Resume" },
                                                { label: "Stop" }
                                            ]
                                        },
                                        {
                                            $type: "LogObject",
                                            label: "a sample object",
                                            o: {
                                                name: {
                                                    first: "Sven",
                                                    last: "V"
                                                },
                                                age: 23,
                                                addresses: [
                                                    {
                                                        street: "Main street",
                                                        number: 99,
                                                        city: {
                                                            name: "Somecity",
                                                            zip: 12345
                                                        }
                                                    },
                                                    {
                                                        street: "Secondary street",
                                                        city: "Somecity"
                                                    }
                                                ],
                                                emptyObj: {},
                                                emptyArr: []
                                            }
                                        }
                                    ]
                                },
                                {
                                    time: "2018-08-23 23:43:51",
                                    category: "General",
                                    elements: [
                                        {
                                            $type: "LogMessage",
                                            text: "Hello World!"
                                        }
                                    ]
                                }
                            ];
                            app.commands = [
                                { label: "Go" },
                                { label: "Quit" }
                            ];
                        });
                }
            })

        </script>
    </body>
</html>